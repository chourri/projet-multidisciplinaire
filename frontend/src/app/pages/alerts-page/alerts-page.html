<app-header></app-header>

<div class="min-h-screen bg-[#f8f9fa] text-slate-800 font-sans pb-24">
  
  <div class="container mx-auto max-w-6xl px-6 pt-16">

    <div class="flex flex-col md:flex-row justify-between items-end mb-12">
      <div>
        <h1 class="text-4xl font-serif font-bold text-slate-900 mb-4 leading-tight">
          National Extreme Event <br>
          <span class="text-sky-900">Registry & Forecast Log</span>
        </h1>
        <div class="prose prose-sm text-slate-600 max-w-2xl leading-relaxed">
          <p>
            Official record of meteorological anomalies detected by the CEEPS Neuro-Symbolic Engine.
            This document serves as the primary data source for disaster mitigation planning in the 
            <strong>Beni Mellal-Khenifra</strong> administrative region.
          </p>
        </div>
      </div>

      <div class="mt-6 md:mt-0 mb-2">
        <button 
          (click)="downloadCSV()" 
          class="group flex items-center gap-3 text-sky-800 font-bold uppercase tracking-widest text-xs hover:text-orange-600 transition-colors"
        >
          <span>Download CSV Report</span>
          <span class="w-8 h-8 border border-sky-800 group-hover:border-orange-600 flex items-center justify-center rounded-full transition-colors">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
          </span>
        </button>
      </div>
    </div>

    <div class="overflow-hidden">
      <table class="w-full text-left border-collapse">
        
        <thead>
          <tr>
            <th class="py-4 pr-6 text-xs font-bold uppercase tracking-widest text-slate-900 border-b-2 border-slate-900">Observation Date</th>
            <th class="py-4 px-6 text-xs font-bold uppercase tracking-widest text-slate-900 border-b-2 border-slate-900">Meteorological Parameters</th>
            <th class="py-4 px-6 text-xs font-bold uppercase tracking-widest text-slate-900 border-b-2 border-slate-900">Alert Classification</th>
            <th class="py-4 px-6 text-xs font-bold uppercase tracking-widest text-slate-900 border-b-2 border-slate-900">Risk Level</th>
            <th class="py-4 pl-6 text-right text-xs font-bold uppercase tracking-widest text-slate-900 border-b-2 border-slate-900">Reference</th>
          </tr>
        </thead>

        <tbody class="text-sm">
          @for (day of weatherData(); track day.date) {
            
            <tr 
              class="group border-b border-slate-300 transition-colors cursor-pointer"
              [ngClass]="{'bg-slate-100': expandedDate() === day.date, 'hover:bg-slate-50': expandedDate() !== day.date}"
              (click)="toggleDetails(day.date)"
            >
              
              <td class="py-6 pr-6 font-mono text-slate-700 font-medium align-top">
                {{ day.date }}
              </td>

              <td class="py-6 px-6 align-top">
                <div class="grid grid-cols-3 gap-4 text-xs">
                  <div>
                    <span class="block text-slate-400 uppercase text-[10px]">Temp Max</span>
                    <span class="font-bold text-slate-800 text-sm">{{ day.tmax }}°C</span>
                  </div>
                  <div>
                    <span class="block text-slate-400 uppercase text-[10px]">Humidity</span>
                    <span class="font-mono text-slate-600">{{ day.rhum }}%</span>
                  </div>
                  <div>
                    <span class="block text-slate-400 uppercase text-[10px]">Wind</span>
                    <span class="font-mono text-slate-600">{{ day.wspd }} km/h</span>
                  </div>
                </div>
              </td>

              <td class="py-6 px-6 align-top">
                @if (day.alert) {
                  <span class="font-bold text-slate-900 block mb-1">{{ day.alert.type.replace('_', ' ') }}</span>
                  <span class="text-xs text-slate-500 leading-tight block">Anomaly detected via Rule Engine</span>
                } @else {
                  <span class="text-slate-400 italic">No anomalies detected</span>
                }
              </td>

              <td class="py-6 px-6 align-top">
                @if (day.alert) {
                  <span class="inline-block px-3 py-1 text-[10px] font-bold uppercase tracking-widest border"
                    [ngClass]="{
                      'border-red-600 text-red-700 bg-red-50': day.alert.level === 'CRITICAL' || day.alert.level === 'EXTREME',
                      'border-orange-500 text-orange-700 bg-orange-50': day.alert.level === 'HIGH',
                      'border-yellow-500 text-yellow-700 bg-yellow-50': day.alert.level === 'MODERATE'
                    }">
                    {{ day.alert.level }}
                  </span>
                } @else {
                  <span class="text-slate-400 text-xs uppercase tracking-wider font-medium">—</span>
                }
              </td>

              <td class="py-6 pl-6 text-right align-top">
                <button class="text-sky-800 text-xs font-bold uppercase tracking-wide hover:underline decoration-2 underline-offset-4 flex items-center gap-1 ml-auto">
                  <span>{{ expandedDate() === day.date ? 'Close' : 'View Log' }}</span>
                  <svg class="w-3 h-3 transition-transform duration-200" [class.rotate-180]="expandedDate() === day.date" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
              </td>
            </tr>

            @if (expandedDate() === day.date) {
              <tr class="bg-slate-50 shadow-inner animate-fade-in">
                <td colspan="5" class="p-0">
                  <div class="p-8 border-b border-slate-300 grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <div>
                      <h4 class="font-serif font-bold text-slate-900 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        Neuro-Symbolic Inference Log
                      </h4>
                      <div class="bg-slate-900 text-slate-300 p-4 rounded-sm font-mono text-xs leading-relaxed border-l-4 border-orange-500 shadow-sm">
                        <p class="mb-2"><span class="text-slate-500">TIMESTAMP:</span> {{ day.date }}T08:00:00Z</p>
                        <p class="mb-2"><span class="text-slate-500">MODEL_V:</span> LSTM_RESNET_1.2</p>
                        <p class="text-orange-300">> {{ getReasoning(day.alert?.type || 'NORMAL', day.tmax) }}</p>
                        <p class="mt-2 text-green-400">> CONFIDENCE_INTERVAL: 96.4%</p>
                      </div>
                    </div>

                    <div>
                      <h4 class="font-serif font-bold text-slate-900 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Recommended Mitigation Protocol
                      </h4>
                      <div class="bg-white border border-slate-200 p-4 rounded-sm text-sm text-slate-700 shadow-sm">
                        @if (day.alert?.level === 'CRITICAL' || day.alert?.level === 'EXTREME') {
                          <ul class="space-y-2 list-disc list-inside marker:text-red-500">
                            <li><strong>Activate Red Plan:</strong> Notify Civil Protection units in Beni Mellal.</li>
                            <li><strong>Public Health:</strong> Issue hydration warnings via SMS gateway.</li>
                            <li><strong>Infrastructure:</strong> Monitor grid load for potential heat-induced failures.</li>
                          </ul>
                        } @else if (day.alert) {
                          <ul class="space-y-2 list-disc list-inside marker:text-orange-500">
                            <li><strong>Advisory Notice:</strong> Alert local agricultural sector regarding irrigation needs.</li>
                            <li><strong>Monitoring:</strong> Increase sampling frequency of sensors to 15-minute intervals.</li>
                          </ul>
                        } @else {
                          <p class="text-slate-500 italic">No specific action required. Continue standard monitoring.</p>
                        }
                      </div>
                      <div class="mt-4 flex gap-4 text-[10px] text-slate-400 font-mono uppercase">
                        <span>ID: {{ day.date.replace('-','') }}-LOG</span>
                        <span>•</span>
                        <span>Auth: AUTO-SYS</span>
                      </div>
                    </div>

                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
      
      @if (weatherData().length === 0) {
        <div class="py-12 text-center border-b border-slate-300">
          <p class="text-slate-400 italic font-serif">System initializing... Awaiting model output.</p>
        </div>
      }
    </div>

    <div class="mt-12 flex items-start gap-4 p-6 bg-slate-100 border-l-4 border-slate-400">
      <div class="font-serif italic text-slate-500 text-sm leading-relaxed">
        <strong>Official Disclaimer:</strong> This automated registry is generated by the CEEPS v1.0 prototype. 
        While the Neuro-Symbolic architecture provides high-confidence predictions, all critical alerts 
        must be verified by the Directorate of Meteorology before public dissemination.
      </div>
    </div>

  </div>
</div>